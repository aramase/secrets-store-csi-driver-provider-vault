---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault
  labels:
    app: vault
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: role-tokenreview-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
- kind: ServiceAccount
  name: vault
  namespace: csi
---
apiVersion: v1
kind: Pod
metadata:
  name: vault
  labels:
    app: vault
spec:
  serviceAccountName: vault
  containers:
  - name: vault
    image: registry.hub.docker.com/library/vault:1.6.1
    imagePullPolicy: IfNotPresent
    args: ['server', '-dev']
    securityContext:
      capabilities:
        add: ['IPC_LOCK']
    ports:
    - containerPort: 8200
      name: vault-port
      protocol: TCP
    - containerPort: 8201
      name: cluster-port
      protocol: TCP
    env:
    - name: POD_IP_ADDR
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: VAULT_LOCAL_CONFIG
      value: |
        api_addr     = "http://127.0.0.1:8200"
        cluster_addr = "http://$(POD_IP_ADDR):8201"
    - name: VAULT_DEV_ROOT_TOKEN_ID
      value: "root" ## THIS IS NOT A PRODUCTION DEPLOYMENT OF VAULT!
    - name: VAULT_ADDR
      value: http://127.0.0.1:8200
    - name: VAULT_TOKEN
      value: root
    readinessProbe:
      httpGet:
        path: /v1/sys/health
        port: 8200
        scheme: HTTP
      initialDelaySeconds: 5
      periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: vault
  labels:
    app: vault
spec:
  ports:
    - name: http
      port: 8200
      targetPort: 8200
    - name: https-internal
      port: 8201
      targetPort: 8201
  selector:
    app: vault
